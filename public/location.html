<!DOCTYPE html>
<html>
    <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

      <!-- vehicle api 必須 : ここから-->
      <script src="http://52.193.125.145:3000/socket.io/socket.io.js"></script>
      <script src="http://52.193.125.145:3000/www/js/vehicleAPI.js"></script>
      <script src="http://52.193.125.145:3000/www/js/vehicleAPI-client.js"></script>
      <!-- vehicle api 必須 : ここまで -->

      <!-- Map -->
	    <script src="http://support.chizumaru.com/aspusers/online_manual/AjaxFramework/3.3.13/lib/Mapple.js" type="text/javascript"></script>
	    <script src="http://support.chizumaru.com/aspusers/online_manual/AjaxFramework/3.3.13/lib/slider.js" type="text/javascript"></script>
	    <script src="http://support.chizumaru.com/aspusers/online_manual/AjaxFramework/3.3.13/lib/scrollmap.js" type="text/javascript"></script>
      <script src="https://code.jquery.com/jquery-2.2.0.min.js" type="text/javascript"></script>
      <script src="js/weather.js" type="text/javascript"></script>
      <script src="js/light.js" type="text/javascript"></script>
      <style>
        #map{
            width:500px;
            height:430px;
            position: absolute;
            z-index:-1;
        }
      </style>
      <script>
        var map;
        var x=502933;
        var y=128472;
        var w=700;
        var h=500;
        var scl=300;
        var iconLayer;
        var Myid = "MyCar";


        var sideOffset = {leftSideOffset: 0, rightSideOffset: 0, topSideOffset: 0, bottomSideOffset: 0};

      window.onload = function () {

      	document.getElementById("connect").addEventListener('click', function(){
          var msg = {"roomID":document.getElementById("WSRoomID").value, "data":"NOT REQUIRED"};
          socket.emit('joinRoom', JSON.stringify(msg));
        });
        map = new Mapple.SingleMap("map", w, h, x, y, scl, {k1: "kddisou", k2: "2238ader", position: "relative", datum: "wgs84", beforeAreaAction:function(mode){
             iconLayer.update(Myid, { x:x, y:y });
        }});
        // オーバーレイアイコンレイヤ作成
        iconLayer = map.createOverlayIcons();
        // アイコン追加
        iconLayer.append(Myid, x, y, {name: "現在地", normalSrc: "img/redcar.png"});

        var gVehicleSpeed = 0;
        var gEngineSpeed = 0;
        var vehicleSpeedSub = navigator.vehicle.vehicleSpeed.subscribe(function(vehicleSpeed) {
          document.getElementById("Vspeed").innerHTML = Math.floor(vehicleSpeed.speed /1000);
        });
        var engineSpeedSub = navigator.vehicle.engineSpeed.subscribe(function(engineSpeed) {
          document.getElementById("Espeed").innerHTML = Math.floor(engineSpeed.speed /1000);
        });
        //ドア開閉運転席
        var zone_fr = new Zone();
        zone_fr.value = [zone_fr.Front, zone_fr.Right];

        navigator.vehicle.door.subscribe(function(door) {
            console.log("door(front right) : " + door.status);
            document.getElementById("idDoor_fr").innerHTML = door.status;

        }, zone_fr);

        navigator.vehicle.seat.subscribe(function(seat) {
            console.log("seatbelt(front right) : " + seat.seatbelt);
            document.getElementById("idSeatbelt_fr").innerHTML = seat.seatbelt;

        }, zone_fr);
		//ドア開閉助手席
        var zone_fl = new Zone();
        zone_fl.value = [zone_fr.Front, zone_fr.Left];

        navigator.vehicle.door.subscribe(function(door) {
            console.log("door(front left) : " + door.status);
            document.getElementById("idDoor_fl").innerHTML = door.status;
        }, zone_fl);
		//
          var getSteeringWheel = function() {
              navigator.vehicle.steeringWheel.get().then(function(steeringWheel) {
                  console.log("steeringWheel angle : " + steeringWheel.angle);
                  document.getElementById("SteeringWheel").innerHTML = Math.floor(steeringWheel.angle);
              },
              function(error) {
                  console.log("get steeringWheel error : " + error);
              });
          }

	        var locationSub = navigator.vehicle.location.subscribe(function(location) {
	        var oldLatitude;
	        var oldLongitude;

	        x= parseFloat(location.longitude*3600);
	        y= parseFloat(location.latitude*3600);

	        if(oldLatitude === undefined || oldLongitude === undefined){
	          //初回
	          oldLatitude = location.latitude;
	          oldLongitude = location.longitude;


	        } else if(oldLatitude === location.latitude && oldLongitude === location.longitude) {
	          //前回と位置が同じ : do nothing
	          return;
	        } else {
	          //前回と位置が異なる
	          oldLatitude = location.latitude;
	          oldLongitude = location.longitude;
	        }
            map.moveMap(x, y, scl, sideOffset);
	      });
	  }
      </script>
    </head>
    <body>
      <div>
        Room ID:<input type=text id="WSRoomID" value="34363bced106"> </input><button id="connect">Start</button>
      </div>

      <div id="map"></div>
      <div id="data">
      	<div id="Vspeed"></div>
      	<div id="Espeed"></div>
      	<div id="idDoor_fr"></div>
      	<div id="idSeatbelt_fr"></div>
      	<div id="idDoor_fl"></div>
      	<div id="SteeringWheel"></div>
      </div>
    </body>
</html>
